#!/bin/sh

##########################################################################
#   Function description:
#       
#   Arguments:
#       
#   Returns:
#       
#   History:
#   Date        Name        Modification
#   2014-02-19  Jason Bacon Begin
##########################################################################

canonical_path()
{
    local start_dir
    
    start_dir=`pwd`
    cd $1
    pwd -P
    cd $start_dir
}

# Don't throw non-canonical paths like $(pwd)/../../dir at dblatex.
# It gets confused and can't find images used in nested xincluded files.
print_dirs()
{
    for file in $@; do
	dir=`dirname $file`
	path=`canonical_path $dir`
	printf "$dirs $path\n"
    done
}

if [ $# -lt 1 ]; then
    printf "Usage: $0 main-source-file other-source-files\n"
    exit 1
fi

cat << EOM > Makefile

#############################################################################
# This makefile was generated by $0.
# Do not edit!
#############################################################################

EOM

main=$1

temp=`print_dirs $* | sort | uniq`
# Strip out newlines
for dir in $temp; do
    dirs="${dirs}:$dir"
done

html_target=HTML/index.html
html_view_cmd=webbrowser
pdf_target=${main%.dbk}.pdf
pdf_view_cmd=docviewer

cat << EOM > view-pdf
#!/bin/sh -e

docviewer $pdf_target
EOM

cat << EOM >> Makefile
# Standard vars for APE
BIN=        view-pdf
TARGET=     $pdf_target
SOURCES=    $*

.PHONY: pdf html install

pdf: $pdf_target

html: $html_target

${pdf_target}: \${SOURCES}
	dbk-insert-date $main ${main%.dbk}
	dbk-genpdf dblatex ${main%.dbk} $dirs
	rm -f ${main%.dbk}

${html_target}: \${SOURCES}
	dbk-insert-date $main ${main%.dbk}
	dbk-genhtml ${main%.dbk} $dirs
	rm -f ${main%.dbk}
	./get-images

clean:
	rm -rf $pdf_target HTML

view: pdf
	$pdf_view_cmd $pdf_target

view-html:
	$html_view_cmd $html_target

publish: pdf html install
	./publish

install: pdf html
	./install

EOM
